FROM node:16.14.0-alpine AS base

ARG REACT_APP_MIDDLEWARE_URL
ENV REACT_APP_MIDDLEWARE_URL "$REACT_APP_MIDDLEWARE_URL"

ARG REACT_APP_ORG_LOGO_URL
ENV REACT_APP_ORG_LOGO_URL "$REACT_APP_ORG_LOGO_URL"

ARG REACT_APP_THEME
ENV REACT_APP_THEME "$REACT_APP_THEME"

ARG REACT_APP_ORG_NAME
ENV REACT_APP_ORG_NAME "$REACT_APP_ORG_NAME"

ARG REACT_APP_ORG_FAVICON_URL
ENV REACT_APP_ORG_FAVICON_URL "$REACT_APP_ORG_FAVICON_URL"

ARG REACT_APP_ORG_FONT_URL
ENV REACT_APP_ORG_FONT_URL "$REACT_APP_FONT_URL"

ARG REACT_APP_ORG_PRIMARY_FONT_NAME
ENV REACT_APP_ORG_PRIMARY_FONT_NAME "$REACT_APP_PRIMARY_FONT_NAME"

ARG REACT_APP_ORG_SECONDARY_FONT_NAME
ENV REACT_APP_ORG_SECONDARY_FONT_NAME "$REACT_APP_SECONDARY_FONT_NAME"

WORKDIR /usr/src/app

EXPOSE 3000

COPY ./frontend/package*.json ./

RUN npm install

COPY ./frontend ./

RUN npm run build

### --- Final Image --- ###
FROM base 

ENV NODE_ENV "production"

USER root

RUN \
    apk --no-cache --update add dumb-init && \
    rm -rf /var/cache/apk/*

RUN npm install -g serve

USER 1000:1000

USER node
WORKDIR /build

COPY --from=base /usr/src/app/build ./

ENTRYPOINT [ "/usr/bin/dumb-init", "--" ]
CMD ["serve", "-d", "-l", "tcp://0.0.0.0:${PORT}", "-s", "/build"]
